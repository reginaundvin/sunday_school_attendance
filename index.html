<!DOCTYPE html>
<html lang="en">
<head>
<!-- ...meta and style unchanged... -->
</head>
<body>
<header>
  <h1>Sunday School Attendance</h1>
  <span class="tag">Offline Â· Data stays in this browser</span>
  <span class="tag">Export/Import supported</span>
</header>

<div class="container">
  <aside>
    <!-- ...unchanged... -->
  </aside>

  <main>
    <div class="card">
      <div class="section-title">
        <h2 id="currentClassTitle">No class selected</h2>
        <div class="row">
          <button class="btn warn" onclick="renameClass()" id="btnRenameClass" disabled>Rename</button>
          <button class="btn danger" onclick="deleteClass()" id="btnDeleteClass" disabled>Delete</button>
        </div>
      </div>
      <div class="muted small mb12">Tip: switch sections below to manage roster, take attendance, and export reports.</div>
      <div class="row mb12">
        <button class="btn secondary" onclick="switchTab('roster')" id="tabRoster">Roster</button>
        <button class="btn secondary" onclick="switchTab('attendance')" id="tabAttendance">Attendance</button>
        <button class="btn secondary" onclick="switchTab('reports')" id="tabReports">Reports</button>
        <button class="btn secondary" onclick="switchTab('backup')" id="tabBackup">Backup</button>
      </div>
    </div>

    <!-- ...roster and attendance sections unchanged, except changes below... -->

    <section id="view-attendance" class="card hidden">
      <div class="section-title">
        <h2>Take Attendance</h2>
        <div class="row">
          <input id="attendanceDate" type="date">
          <button class="btn ok" onclick="markAll('Present')">Mark All Present</button>
          <button onclick="markAll('Absent')">All Absent</button>
          <!-- Removed All Excused button -->
          <button class="btn" onclick="saveAttendance()">Save</button>
          <button onclick="printSheet()">Print Sheet</button>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Status</th><th>Note</th></tr>
        </thead>
        <tbody id="attendanceBody"></tbody>
      </table>
    </section>

    <section id="view-reports" class="card hidden">
      <div class="section-title">
        <h2>Reports</h2>
        <div class="row">
          <input id="fromDate" type="date">
          <span>to</span>
          <input id="toDate" type="date">
          <button class="btn" onclick="refreshReport()">Refresh</button>
          <!-- Removed Export CSV and Google Sheets backup buttons -->
          <button onclick="exportXLSX()">ðŸ“‘ Export Excel (styled)</button>
        </div>
      </div>
      <div id="reportSummary" class="mb12"></div>
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Present</th><th>Absent</th><th>Total</th><th>% Present</th></tr>
        </thead>
        <tbody id="reportBody"></tbody>
      </table>
    </section>

    <!-- ...backup section unchanged... -->
  </main>
</div>

<footer>
  Made for Sunday Schools. Works offline. Keep a backup regularly.
  <!-- ...unchanged... -->
</footer>
<!-- ...script includes unchanged... -->

<script>
// ======= Data Layer, Roster, UI helpers, etc. unchanged =======

// ======= Attendance =======
const STATUSES = ['Present','Absent']; // Only Present and Absent

function renderAttendance(){
  const c = getSelectedClass();
  const tbody = $('attendanceBody');
  if(!c){ tbody.innerHTML = '<tr><td colspan="4" class="muted">Select a class first.</td></tr>'; return; }
  $('attendanceDate').value = $('attendanceDate').value || formatDate(new Date());
  const date = $('attendanceDate').value;
  const today = c.attendance[date] || {};
  tbody.innerHTML = '';
  if(c.students.length===0){ tbody.innerHTML = '<tr><td colspan="4" class="muted">No students in roster.</td></tr>'; return; }
  c.students.forEach((s,i)=>{
    const record = today[s.id] || { status:'', note:'' };
    const statusOpts = STATUSES.map(st=>`<option ${st===record.status?'selected':''}>${st}</option>`).join('');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(s.name)}</td>
      <td><select class="status-select" data-student="${s.id}"><option value="">â€”</option>${statusOpts}</select></td>
      <td><input type="text" data-note-for="${s.id}" value="${escapeAttr(record.note||'')}" placeholder="Optional note (ill, travel, etc.)"></td>`;
    tbody.appendChild(tr);
  });
}

function markAll(status){
  const selects = document.querySelectorAll('#attendanceBody select.status-select, #attendanceBody select');
  selects.forEach(sel=>{ sel.value = status; });
}

// ======= Reports =======
function refreshReport(){
  const c = getSelectedClass(); 
  const body = $('reportBody');
  const summary = $('reportSummary');
  body.innerHTML=''; summary.innerHTML='';
  if(!c){ body.innerHTML = '<tr><td colspan="6" class="muted">Select a class.</td></tr>'; return; }
  const allDates = Object.keys(c.attendance).sort();
  if(allDates.length===0){ body.innerHTML = '<tr><td colspan="6" class="muted">No attendance recorded yet.</td></tr>'; return; }
  const from = $('fromDate').value || allDates[0];
  const to = $('toDate').value || allDates[allDates.length-1];
  $('fromDate').value = from; $('toDate').value = to;

  // compute
  const rows = c.students.map((s)=>({ id:s.id, name:s.name, Present:0, Absent:0, Total:0 }));
  const dates = datesInRange(from,to);
  dates.forEach(date=>{
    const day = c.attendance[date] || {};
    rows.forEach(r=>{
      const rec = day[r.id];
      if(rec && rec.status){
        r[rec.status] += 1;
        r.Total += 1;
      }
    });
  });

  // totals
  let totalMeetings = dates.filter(d => c.attendance[d]).length;
  summary.innerHTML = `<div class="pill">Meetings counted: ${totalMeetings}</div>`;

  rows.forEach((r,i)=>{
    const pct = r.Total ? Math.round((r.Present/r.Total)*100) : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.name)}</td>
      <td>${r.Present}</td><td>${r.Absent}</td>
      <td>${r.Total}</td><td>${pct}%</td>`;
    body.appendChild(tr);
  });
}

// Return a 2D array representing the current class report (for Excel)
function buildReportMatrix(){
  const c = getSelectedClass(); 
  const from = $('fromDate').value;
  const to = $('toDate').value;
  if(!c) throw new Error('Select a class.');
  // Add period string with full date/month/year
  const periodStr = `Period: ${from || ''} to ${to || ''}`;
  const headers = ['#','Name','Present','Absent','Total','% Present'];
  const rows = c.students.map((s)=>({ id:s.id, name:s.name, Present:0, Absent:0, Total:0 }));
  const dates = datesInRange(from,to);
  dates.forEach(date=>{
    const day = c.attendance[date] || {};
    rows.forEach(r=>{
      const rec = day[r.id];
      if(rec && rec.status){ r[rec.status]++; r.Total++; }
    });
  });
  const matrix = [ [c.name+' â€” Report'], [periodStr], [], headers ];
  rows.forEach((r,i)=>{
    const pct = r.Total ? Math.round((r.Present/r.Total)*100) : 0;
    matrix.push([i+1, r.name, r.Present, r.Absent, r.Total, pct+'%']);
  });
  return {matrix, title: c.name, from, to};
}

// ======= Export XLSX only =======
function exportXLSX(){
  const c = getSelectedClass(); if(!c) return alert('Select a class');
  const from = $('fromDate').value; const to = $('toDate').value;
  const {matrix} = buildReportMatrix();

  const ws = XLSX.utils.aoa_to_sheet(matrix);

  // Add borders
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R=0; R<=range.e.r; ++R){
    for(let C=0; C<=range.e.c; ++C){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      if(ws[addr]){
        ws[addr].s = ws[addr].s || {};
        ws[addr].s.border = {
          top:    {style: "thin", color: {rgb:"CCCCCC"}},
          bottom: {style: "thin", color: {rgb:"CCCCCC"}},
          left:   {style: "thin", color: {rgb:"CCCCCC"}},
          right:  {style: "thin", color: {rgb:"CCCCCC"}}
        };
        // Bold header row
        if(R === 3) ws[addr].s.font = {bold: true};
      }
    }
  }

  // Auto-size columns
  ws['!cols'] = matrix[3].map((h,i)=>({wch: Math.max(String(h||'').length, ...matrix.slice(4).map(r=>String(r[i]||'').length))+2}));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, (c.name.replace(/[^a-z0-9]+/gi,'-').toLowerCase()||'class')+"-attendance.xlsx");
}

// ======= Remove Export CSV and Google Sheets logic entirely =======

/* 
  - Removed exportCSV, backupReportToGoogleSheets, and related UI/buttons.
  - Removed 'Late' and 'Excused' everywhere.
  - Added date/month/year period to Excel.
  - Added borders in Excel.
*/

// ======= Init =======
function firstTimeSeed(){
  if(Object.keys(db.classes).length) return;
  const id = uid();
  db.classes[id] = { id, name: 'Sample Class', students: [
    {id:uid(), name:'Alice'}, {id:uid(), name:'Ben'}, {id:uid(), name:'Chandra'}
  ], attendance:{} };
  db.selectedClassId = id;
  saveData();
}

function init(){
  firstTimeSeed();
  renderClassList();
  refreshClassHeader();
  switchTab('attendance');
  // default dates
  $('attendanceDate').value = formatDate(new Date());
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>